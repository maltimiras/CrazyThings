<meta name="apple-mobile-web-app-capable" content="yes" />
<meta http-equiv="cache-control" content="no-cache" />
<meta charset="UTF-8"/>
<html>
    <head>
        <title>Verb Tenses Quiz</title>
        <link rel="apple-touch-icon" href="virus.png">
        <link rel="icon" href="virus.png" type="image/gif" sizes="32x32">
    </head>
    <style>
        div {
            font-size: 5.9vw;
        }     
        button{
            font-size: 5.9vw;
        }
        input {
            font-size: 5.9vw;
        }
        body {
            margin-top: 3vw;
            margin-bottom: 3vw;
            margin-right: 3vw;
            margin-left: 3vw;
        }

        div .GameSelector {
            font-size: 2vw;    
        }

        .GameSelector h1 {
            font-size: 3vw;   
            display: inline; 
        }

        .verbblock {
            margin:0 3vw 0 3vw;
            display: inline-block;
            float: left; 
        }

        .GameSelectorVerbs {
            overflow: auto;
        }

        .GameSelectorVerbs h1,
        .GameSelectorVerbs h2 {
            font-size: 2vw;   
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .GameSelectorVerbs li {
            font-size: 1.5vw;   
        }

        .GameSelectorVerbs p {
            margin: 0;   
        }

        .subject {
            color:blue; 
            display:inline;   
        }
        .verb {
            color:blue; 
            display:inline;   
        }
        .auxiliar {
            color:red; 
            display:inline;   
        }
        .form {
            color:yellowgreen; 
            display:inline;   
        }
    </style>
    <body>
        <div id="header">
        </div>
        <div id="screen">
        </div>
        <div id="foot">
        </div>
    </body>
    <script src="serialize-0.2.min.js"></script>
    <script src="verbs.js"></script>
    <script src="verbs-cat.js"></script>
    <script>
        var users = {
            Guillem:"Guillem.png",
            Sergi:"Sergi.png",
            Cai:"Cai.png",
            Marc:"Marc.png"
        };

        var subjects = {
            s1PS:"The first person singular",
            s2PS:"The second person singular",
            s3PSm:"The third person singular masculine",
            s3PSf:"The third person singular feminine",
            s3PSi:"The third person singular neutral",
            s1PP:"The first person plural",
            s2PP:"The second person plural",
            s3PP:"The third person plural"
        };

        var tenses = {
            Present: "Present",
            PastSimple: "PastSimple",
            PresentContinous: "PresentContinous",
            Future: "Future"
        };

        var help = {
            Present: "<h1>Present</h1><br>To Be/To Have -> Irregulars<br>3rd  Singular Person: <font class='verb'>verb</font> + s/es<br><br><b>Affirmative</b>: <font class='subject'>subject</font> + <font class='verb'>verb</font> + ...<br><b>Interrogative</b>: 	<font class='auxiliar'>DO/DOES</font> + <font class='subject'>subject</font> + <font class='verb'>verb</font> + ...<br><b>Negative</b>: <font class='subject'>subject</font> + <font class='auxiliar'><font class='auxiliar'>DO/DOES</font></font> + <font class='auxiliar'>NOT</font> + <font class='verb'>verb</font> +&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or <font class='auxiliar'>(DON’T/DOESN’T)</font><br><br><a href='https://open.books4languages.com/english-a1-grammar-es/chapter/to-be-affirmative/' target='_blank'>To Be en Afirmativo</a><br><a href='https://open.books4languages.com/english-a1-grammar-es/chapter/to-be-negative/' target='_blank'>To Be en Negativo</a><br><a href='https://open.books4languages.com/english-a1-grammar-es/chapter/to-be-interrogative/' target='_blank'>To Be en Interrogativo</a><br><a href='https://open.books4languages.com/english-a1-grammar-es/chapter/have-and-have-got-affirmative/' target='_blank'>Have/Have got en Afirmativo</a><br><a href='https://open.books4languages.com/english-a1-grammar-es/chapter/have-and-have-got-negative/' target='_blank'>Have/Have got en Negativo</a><br><a href='https://open.books4languages.com/english-a1-grammar-es/chapter/have-and-have-got-interrogative/' target='_blank'>Have/Have got en Interrogativo</a><br><a href='https://open.books4languages.com/english-a1-grammar-es/chapter/present-simple-affirmative/' target='_blank'>Presente del Indicativo en Afirmativo</a><br><a href='https://open.books4languages.com/english-a1-grammar-es/chapter/present-simple-negative/' target='_blank'>Presente del Indicativo en Negativo</a><br><a href='https://open.books4languages.com/english-a1-grammar-es/chapter/present-simple-interrogative/' target='_blank'>Presente del Indicativo en Interrogativo</a><br>",
            PastSimple: "<h1>Preterite / Past Simple</h1><br>Regular: <font class='verb'>verb</font>(<font class='form'>infinitive</font>)  + ed<br><br><b>Affirmative</b>: <font class='subject'>subject</font> + <font class='verb'>verb</font>(<font class='form'>preterite</font>) + ...<br><b>Interrogative</b>: 	<font class='auxiliar'>DID</font> + <font class='subject'>subject</font> + <font class='verb'>verb</font>(<font class='form'>infinitive</font>) + ...<br><b>Negative</b>: <font class='subject'>subject</font> + <font class='auxiliar'>DID</font> + <font class='auxiliar'>NOT</font> + <font class='verb'>verb</font>(<font class='form'>infinitive</font>) +&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; or (<font class='auxiliar'>DIDN´T</font>)<br><br><a href='https://open.books4languages.com/english-a1-grammar-es/chapter/past-simple-of-to-be/' target='_blank'>Pasado Simple de To be</a><br><a href='https://open.books4languages.com/english-a1-grammar-es/chapter/past-simple-affirmative/' target='_blank'>El Pasado Simple en Afirmativo</a><br><a href='https://open.books4languages.com/english-a1-grammar-es/chapter/past-simple-negative/' target='_blank'>El Pasado Simple en Negativo</a><br><a href='https://open.books4languages.com/english-a1-grammar-es/chapter/past-simple-interrogative/' target='_blank'>El Pasado Simple en Interrogativo</a><br><a href='https://open.books4languages.com/english-a1-grammar-es/chapter/past-simple-of-irregular-verbs/' target='_blank'>El Pasado Simple de Verbos Irregulares</a><br>",
            PresentContinous: "<h1>Present Continuous</h1><br><b>Affirmative</b>: <font class='subject'>subject</font> + <font class='auxiliar'>TO BE CONJUGATED</font> + <font class='verb'>verb</font> + <font class='auxiliar'>ING</font> + ...<br><b>Interrogative</b>: 	<font class='auxiliar'>TO BE CONJUGATED</font> + <font class='subject'>subject</font> + <font class='verb'>verb</font> + <font class='auxiliar'>ING</font> + ...<br><b>Negative</b>: <font class='subject'>subject</font> + <font class='auxiliar'>TO BE CONJUGATED</font> + <font class='auxiliar'>NOT</font> + <font class='verb'>verb</font> + <font class='auxiliar'>ING</font> +&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or (<font class='auxiliar'>AREN’T/ISN’T</font>)<br><br><a href='https://open.books4languages.com/english-a1-grammar-es/chapter/present-continuous-affirmative/' target='_blank'>El Presente Continuo en Afirmativo</a><br><a href='https://open.books4languages.com/english-a1-grammar-es/chapter/present-continuous-negative/' target='_blank'>El Presente Continuo en Negativo</a><br><a href='https://open.books4languages.com/english-a1-grammar-es/chapter/present-continuous-interrogative/' target='_blank'>El Presente Continuo en Interrogativo</a><br>",
            Future: "<h1>Future</h1></br><b>Affirmative</b>: <font class='subject'>subject</font> + <font class='auxiliar'>WILL</font> + <font class='verb'>verb</font>(<font class='form'>infinitive</font>) + ...<br><b>Interrogative</b>: 	<font class='auxiliar'>WILL</font> + <font class='subject'>subject</font> + <font class='verb'>verb</font>(<font class='form'>infinitive</font>) + ...<br><b>Negative</b>: <font class='subject'>subject</font> + <font class='auxiliar'>WILL</font> + <font class='auxiliar'>NOT</font> + <font class='verb'>verb</font>(<font class='form'>infinitive</font>) +&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or (WON’T)<br><br><a href='https://open.books4languages.com/english-a2-grammar-es/chapter/future-simple-affirmative/' target='_blank'>Futuro Simple Afirmativo</a><br><a href='https://open.books4languages.com/english-a2-grammar-es/chapter/future-simple-negative/' target='_blank'>Futuro Simple en Negativo</a><br><a href='https://open.books4languages.com/english-a2-grammar-es/chapter/future-simple-interrogative/' target='_blank'>Futuro Simple en Interrogativo</a><br>"
        }

        var forms = {
            Affirmative: "Affirmative",
            Negative: "Negative",
            Interrogative: "Interrogative"
        };

        function strUniform(str) {
            for (var i in contractions) {
              str=str.replace(contractions[i][0],contractions[i][1]);
            }
            return str;
            //return str.replace("i'm","i am").replace("are not","aren't").replace("is not","isn't").replace("do not","don't").replace("did not","didn't").replace("does not","doesn't").replace("will not","won't").replace("have not","haven't").replace("has not","hasn't").replace("had not","hadn't");
        }

        // Gestio Verbs
        var currentuser = "";
        var selVerbs = [];
        var selTenses = [];
        var selForms= []; 
        var verb = "";
        var form="";
        var tense="";
        var subject="";
        var answer="";
        var translation="";
        var score =0;
        var total =0;

        // Gestio Impresió.
        function prnt(text,id){ 
            var output = document.getElementById(id || "screen"); 
            output.innerHTML = output.innerHTML + "<br>" + text;
        }

        function prntnl(text,id){ 
            var output = document.getElementById(id || "screen"); 
            output.innerHTML = output.innerHTML + "<br>" + text;
        }

        function prntnobr(text,id){ 
            var output = document.getElementById(id || "screen"); 
            output.innerHTML = output.innerHTML + text;
        }

        function html(id){ 
            var output = document.getElementById(id || "screen"); 
            return output.innerHTML;
        }

        function clr(id) {
            var output = document.getElementById(id || "screen");
            output.innerHTML = "";
        }

        // Gestio Objectes
        function rndkeys(obj) {
            var sskeys=Object.keys(obj);
            var sslength=sskeys.length;
            var ssindex=Math.floor(Math.random() * sslength);  
            return sskeys[ssindex];
        }

        function rndkeysOnList(obj,listofkeys) {
            //var sskeys=Object.keys(obj);
            var sslklength=listofkeys.length;
            var ssindex=Math.floor(Math.random() * sslklength); 
            return listofkeys[ssindex];
        }

        function strProper(str) {
            return str.replace(/([A-Z])/g, ' $1').trim();
        }

        function strClean(str) {
            return str.replace(/[^\x20-\x7E]/g, '');
        }
        /*
        function PlaySound(soundObj) {
            var sound = document.getElementById(soundObj);
            sound.Play();
        } 
        <embed src="success.wav" autostart="false" width="0" height="0" id="sound1"
        enablejavascript="true">
        */

        ///////////////////////////////////////////
        // STATE Cover
        function Cover(){
            prnt("<img src='cover.png'style='margin-left:auto;margin-right:auto;width:50vw;display:block;'>");
            prnt("<center>English Time</center>");
            setTimeout(UserSelection,4500);
        }
        
        ///////////////////////////////////////////
        // STATE User Selection
        function UserSelection() {
            clr();
            var lusers=Object.keys(users);
            lusers.forEach(prntUser);
        }

        function prntUser(value) {
            prnt("<img src='"+users[value]+"' onclick='clickImg(&#34;"+value+"&#34;)' style='margin-left:auto;margin-right:auto;width:20vw;display:block;'>");
        }

        function clickImg(value){
            currentuser=value;
            setTimeout(GameSelectors,500);
        }
        
        ///////////////////////////////////////////
        // STATE Game Selectors

        function GameSelectors() {
            clr();clr("header");clr("foot");
            prnt("<h1>Tenses</h1>");
            var ltenses = Object.keys(tenses);
            ltenses.forEach(prntCheckTenses);
            prnt("<br><h1>Forms</h1>");
            var lforms = Object.keys(forms);
            lforms.forEach(prntCheckForms);
            prnt("<br><h1>Verbs</h1>");
            var lverbs = Object.keys(verbs);
            lverbs.forEach(prntCheckVerbs);
            prnt("<button onclick='onStart();'>Start</button>","foot");

            var strScreen = html();

            clr();prnt("<div class='GameSelector'>"+strScreen+"</div>");
        }
        
        function prntCheckTenses(value){
            prnt(strProper(value) +"<a id='"+value+"' href='javascript: function() {return false;}' onclick='helpTenses(this)'>?</a>"+ " <input type='checkbox' name='Tenses' id='"+value+"' checked>");
        }

        function helpTenses(e) {
            //alert("tenses "+e.id);
            clr("header");
            prnt("<div class='GameSelector'>"+help[e.id]+"</div>","header");
        }

        function prntCheckForms(value){
            prnt(strProper(value) + "<input type='checkbox' name='Forms' id='"+value+"' checked>");
        }

        function prntCheckVerbs(value){
            prnt(strProper(value) +"<a id='"+value+"' href='javascript: function() {return false;}' onclick='helpVerbs(this)'>?</a>"+ "<input type='checkbox' name='Verbs' id='"+value+"' checked>");
        }

        function prntTree(obj,recursive){
            //alert(obj);
            var str = "";
            if (recursive>0) {
                var kk = Object.keys(obj);
                for (var i in kk) {
                    str = recursive>1 ? str+kk[i]+"<br>" :str;
                    if (recursive>0) {
                        str+=prntVerbForm(obj[kk[i]],recursive-1);
                    }
                }
            }else{
                str+=obj+"<br>";
            }
            return str;
        }

        function prntTreeFormat(obj,format,formatblock,recursive){
            //alert(obj+":"+format[recursive]+":"+recursive);
            var str = "";
            if (recursive>0) {
                var kk = Object.keys(obj);
                for (var i in kk) {
                    str = recursive>1 ? str+applyFormat(format[recursive],kk[i]) :str;
                    if (recursive>0) {
                        str+=applyFormat(formatblock[recursive],prntTreeFormat(obj[kk[i]],format,formatblock,recursive-1));
                    }
                }
            }else{
                str+=applyFormat(format[recursive],obj);
            }
            return str;
        }

        function applyFormat(strformat,value) {
            return strformat.replace("__",value);
        }

        //"<h2>__<h2>","<h3>__<h3>"
        function prntVerb(verb) {
            var html=prntTreeFormat(verbs[verb],["<p><li>__</li></p>","","<p><h2>__</h2></p>","<div class='verbblock'><p><h1>__</h1></p>"],["__","__","__","__</div>"],3);
            //alert(html);
            /*verbs[verb].Affirmative
            verbs[verb].Negative
            verbs[verb].Interrogative*/
            return html;
        }

        function helpVerbs(e) {
            //alert("tenses "+e.id);
            clr("header");
            var htmlVerb=prntVerb(e.id);
            prntnobr("<div class='GameSelectorVerbs'>"+htmlVerb+"</div>","header");
        }

        function onStart(){
            var lcheckboxes = document.getElementsByTagName('input');
            
            for (var i = 0; i < lcheckboxes.length; i++){
              if (lcheckboxes[i].checked) {  
                if (lcheckboxes[i].name=="Tenses") {
                    selTenses.push(lcheckboxes[i].id);
                }else if (lcheckboxes[i].name=="Forms") {
                    selForms.push(lcheckboxes[i].id); 
                }else {
                    selVerbs.push(lcheckboxes[i].id);
                }
              }
              //prnt(lcheckboxes[i].id+ " "+ lcheckboxes[i].name);
            }
            //prnt(selVerbs.slice());
            //prnt(selForms.slice());
            //prnt(selTenses.slice());
            setTimeout(QuestionAnswers,100);
        }

        ///////////////////////////////////////////
        // STATE Questions and Answers.

        function prntScore() {
            clr("header");
            prnt("Your Score is "+score+" of "+total,"header");    
        }

        function prntFooter() {
            clr("foot");
            prnt("<button onclick='onFinish();'>Finish</button>","foot");      
        }

        function onFinish(){
            clr();
            clr("foot");
            clr("header");
            currentuser = "";
            selVerbs = [];
            selTenses = [];
            selForms= []; 
            verb = "";
            form="";
            tense="";
            subject="";
            answer="";
            translation="";
            score =0;
            total =0;            
            setTimeout(GameSelectors,100);
        }

        function formCreate(formid,lfields) {
            var strForm="<form id='"+formid+"' style='display:none'>";
            //strForm+="<input id='b"+formid+"' type='submit' value='Submit'>";
            for (var field in lfields) {
              strForm+="<input type='text' id='"+formid+lfields[field]+"' name='"+lfields[field]+"'>";    
            } 
            strForm+="</form>";
            prnt(strForm);
        }

        function formSubmit(formid) {
            //#degug alert("formSubmit:");
            var http = new XMLHttpRequest();
            //var params = "user=Guillem&verb=ToSay&form=Interrogative&tense=PresentContinous&subject=s3PSm&result=true";
            var params = serialize(document.getElementById(formid));
            http.open("GET", "https://script.google.com/macros/s/AKfycbxDyKbQsSyaVsLhGQr54gkzLKNobMEKAHu8OfKINEkISHrfImg/exec"+"?"+params, true);
            http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
            //var params = "search=" + "user=Guillem&verb=ToSay&form=Interrogative&tense=PresentContinous&subject=s3PSm&result=true";
             // probably use document.getElementById(...).value
            http.send(null);
            /*#degug http.onload = function() {
                alert(http.responseText);
            }*/
        }

        function formPutValue(formid,values) {
            //#degug alert(values);
            var sskeys=Object.keys(values);
            //#degug alert(sskeys);
            for (var key in sskeys) {
                var input = document.getElementById(formid+sskeys[key]);
                input.value=values[sskeys[key]];   
            }
        }

        function buildQuestion() {
            verb=rndkeysOnList(verbs,selVerbs);
            form=rndkeysOnList(verbs[verb],selForms);
            tense=rndkeysOnList(verbs[verb][form],selTenses);
            subject=rndkeys(verbs[verb][form][tense]);
            return {
                Question: "<B>"+subjects[subject]+"</B> of the verb <B>To "+ verb.split("To")[1] + "</B> in  <B>" +form+ "</B> for the <B>"+ tense +"</B>",
                Answer: verbs[verb][form][tense][subject],
                Translation: verbs_cat[verb][form][tense][subject]
            };
        }

        function buildForm(question) {
            prnt(question);
            prnt("<input type='text' id='tanswer' onkeypress='checkEnter()' autofocus><button id='banswer' onclick='checkAnswer()'>Check</button>");
            document.getElementById("tanswer").select();
        }

        //onkeypress='checkEnter()'

        function checkEnter() {
            try {
                if (event.keyCode === 13) {
                    document.getElementById("banswer").click();
                }
            } catch {}
        }

        function checkAnswer() {
            try {
                //#degug alert("checkAnswer");
                var secs = 3000;
                var ipad = document.getElementById("tanswer").value;
                answer = strUniform(strClean(answer.toLowerCase().trim()));
                entered = strUniform(strClean(document.getElementById("tanswer").value.toLowerCase().trim()));
                document.getElementById("tanswer").style.display = 'none';
                document.getElementById("banswer").style.display = 'none';
                if (entered==answer) {
                    formCreate("result"+total,["user","verb","form","tense","subject","result","answer","answered","ipad"]);
                    //#degug alert("1formCreate");
                    formPutValue("result"+total,{user:currentuser,verb:verb,form:form,tense:tense,subject:subject,result:true,answer:answer,answered:entered,ipad:ipad});
                    formSubmit("result"+total);
                    prnt("Well done<br>");
                    prnt('<font color="green"><B>Correct: </B>'+entered+'</font>');
                    prnt('<font color="blue"><B>Translation: </B>'+translation+'</font>');
                    score+=1;
                }else{
                    formCreate("result"+total,["user","verb","form","tense","subject","result","answer","answered","ipad"]);
                    //#degug alert("2formCreate"+currentuser);
                    formPutValue("result"+total,{user:currentuser,verb:verb,form:form,tense:tense,subject:subject,result:false,answer:answer,answered:entered,ipad:ipad});
                    formSubmit("result"+total);
                    secs = 6000;
                    prnt('<font color="red"><B>Incorrect: </B>'+entered+'</font>');
                    prnt('<font color="green"><B>Correct answer was: </B>'+answer+'</font>');
                    prnt('<font color="blue"><B>Translation: </B>'+translation+'</font>');
                }
            } catch(err) {
                alert(err.message);
            } finally { 
                total+=1;
                prntScore();
                setTimeout(QuestionAnswers,5000);
            }
        }

        // Main Bucle
        function QuestionAnswers() {
            prntScore();
            clr();
            var question=buildQuestion();
            answer=question.Answer;
            translation=question.Translation;
            buildForm(question.Question);
            prntFooter();
        }
        ///////////////////////////////////////////
        // STATE Results

        //main();
        Cover();
    </script>
</html>
